
[Customer.java](Customer.java) Customer.statement() 里面做的事情太多了

## 存在的问题：

在这个例子里，我们的用户希望对系统做一点修改。

- 修改点一  
首先，他们希望以HTML格式输出详单，这样就可以直接在网页上显示，这非常符合时下的潮流。

现在，请你想一想，这个变化会带来什么影响？ 
看看代码你就会发现，根本不可能在 打印HTML报表的函数中， 复用目前 statement() 的任何行为。 
你唯一可以做的就是，编写一个全新的 htmlStatement(), 大量重复 statement() 的行为。 

当然，现在做这个还不太费力，你可以把 statement() 复制一份，然后按需要修改就是了。
但如果计费标准发生变化，又会如何?

你必须同时修改 Customer.statement() 和 Customer.htmlStatement(), 并确保两处修改的一致性。 
当你后续还要再修改时，复制粘贴帶来的问题就浮现出来了。 
如果你编写的是一个永不需要修改的程序，那么剪剪贴贴就还好，但如果程序要保存很长时间，而且可能需要修改，复制粘贴行为就会造成潜在的威胁。

- 现在，第二个变化来了：  
用户希望改变影片分类规则，但是还没有决定怎么改。 
他们设想了几种方案，这些方案都会影响顾客消费和常客积分点的计算方式。 
作为一个经验丰富的开发者，你可以肯定：  
不论用户提出什么方案，你唯一能够获得的保证就是，他们一定会在六个月之内再次修改它。

为了应付分类规则和计费规则的变化，程序必须对  Customer.statement()  做出修改。 
但如果我们把 Customer.statement() 内的代码 复制到，用以打印 HTML详单 的 Customer.htmlStatement() 函数中，
就必须确保，将来的任何修改在两个地方保持一致。 

随着各种规则变得愈来愈复杂，适当的修改点愈来愈难找，不犯错的机会也愈来愈少。

>建议： 
如果你发现，自己需要为程序 添加一个特性，而 当前代码结构 使你无法很方便地达成目的， 
那么就，
首先，**重构** 那个程序，使 ‘特性的添加’ 比较容易进行， 
然后，再 ‘添加特性’。


## 重构的第一步：
每当我要进行重构的时候，第一个步骤永远相同————我得为即将修改的代码，建立一组可靠的 测试环境 。 
这些测试是必要的，因为，尽管遵循重构手法可以使我避免绝大多数引入bug的情形，但我毕竟是人，毕竟有可能犯错。 
所以，我需要可靠的测试。
测试过程中，很重要的一部分，就是，测试程序 对于 结果 的 报告方式。
它们 要么 说 “OK”, 表示所有新字符串都和参考字符串一样，
    要么 就列出失败清单，显示问题字符串的出现行号。
这些测试都能够自我检验。 

是的，你必须让测试**有能力自我检验**，否则，就得耗费大把时间 来回比对，这会降低你的开发速度。 

进行重构的时候，我们需要依赖测试，让它告诉我们是否引入了bug。 好的测试是重构的根本。
花时间建立一个优良的测试机制是完全值得的，因为当你修改程序时，好测试会给你必要的安全保障。 
测试机制在重构领域的地位实在太重要了，我将在第4章详细讨论它。


>建议： 重构之前，首先检查自己是否有一套可靠的测试机制。 这些测试必须有自我检验能力。

## 分解并重组statement()
第⼀个明显引起我注意的就是⻓得离谱的statement()。
每当看到这样⻓⻓的 函数，我就想把它⼤卸⼋块。
要知道，代码块愈⼩，代码的功能就愈容易管理，代码的处理和移动也就愈轻松。

本章重构过程的第一阶段中，我将说明如何把长长的函数切开，并把较小块的代码移至更合适的类。
我希望降低代码重复量，从而使 新的(打印HTML详单用的)函数 更容易 撰写。

第一个步骤是：  
找出代码的 ‘逻辑泥团’，并运用 Extract Method (110)。 

本例一个明显的 ‘逻辑泥团’ 就是 switch 语句，把它提炼到独立函数中似乎比较好。

和任何重构手法一样，当我提炼一个函数时，我必须知道可能出什么错。
如果提炼得不好，就可能给程序引入bug。 
所以，重构之前，我需要先想出安全做法。 
由于，先前我已经进行过数次这类重构，所以，我已经把安全步骤记录于后面的重构列表中了。

首先，我得在 Customer.statement() 函数 的 这段代码里找出 函数内的 **局部变量** 和 **参数**。  
Customer.statement()中， 我找到了两个：  
`each` 和 `thisAmount`，
前者 并未被修改，后者 会被修改。

1）任何‘不会被修改’的变量，都可以被我当成 参数， 传入 新的函数。 比如，这里的`each`；
2）至于‘会被修改’的变量，就需格外小心。  比如这里的`thisAmount`；

如果，只有一个变量会被修改，我可以把它当作返回值。 

由于 `thisAmount` 是个临时变量，
其值，在 每次循环起始处 被设为 0 ，并且，在switch语句执行之前 不会改变， 
所以，我可以直接把 抽取的新函数的返回值 赋给它。


下⾯两页展⽰了重构前后的代码。
重构前的代码在左页，重构后的代码在右页。
凡是从函数提炼出来的代码，以及新代码所做的任何修改，只要我觉得不是明显到可以⼀眼看出，
就以粗体字标⽰出来特别提醒你。
本章剩余部分将延续这种左右⽐对形式。

